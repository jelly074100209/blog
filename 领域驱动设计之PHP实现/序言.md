# 序言

在2014年，经过两年的阅读积累和实践，我的朋友兼同事，Carlos 和 Christian 一起前往柏林参加 Vaughn Vernon 的**实现领域驱动设计**研讨会。期间的训练非常棒，在旅行前所有盘旋在他们脑海里的一些概念变得越来越清晰。然而他们仅仅一屋子的 Java 和 .NET 工程师中的两个 PHPer。

大约在同一时间，一年一度的PHP会议*php[tek]*开始征文，Carlos 向其寄出一篇关于**六边形架构**的论文，不过被拒绝了，但*musketeers.me*的 Eli White 和名声在外的 *php[architect]* 于一个月后和他取得联系，想知道他是否有兴趣为 *php[architect]* 杂志写一篇关于六边形架构的文章。于是在2014年6月，*Hexagonal Architecture with PHP* 发表了，你可以在附录中找到此文，它也是本书的前身。

2014年底，Carlos 和 Christian 提到希望扩展此文并分享他们在生产中实践 DDD 的知识和经验。他们对于此书背后想法感到非常兴奋：即帮助 PHP 社区深入研究 DDD 的实用方法。在当时，富领域模型及框架无关应用的概念在 PHP 社区并不常见。所以在2014年12月，此书首先在 gitbook 上发布了。

大约在同一时间，Keyvan co-founded Funddy 使用基于领域驱动设计概念构建了其技术平台，领域驱动设计在 Funddy 这样的初创公司被证明是行之有效的，同时它也能处理好公司复杂多变的业务场景与需求。在与 Carlos 和 Christian 取得联系并讨论此书后，Keyvan 自豪地签约成为此书的第三位作者。

总之，我们写了这本以领域驱动设计为出发点的书。它充满了丰富的实例，生产级代码，捷径，以及根据我们各自团队中那些好的和不好的经验作出的建议。我们通过**构建块-战术模式**（本书主要讨论的）来诠释领域驱动设计。好好读完此书能帮你学习，编写并实现这些。你也将同时学会如何用同步和异步方法来整合**上下文限界**-一种打开你知识新世界的战略设计方法，尽管这种方法你可以通过自己的方式在未来某个阶段发现。

本书深受 Vaughn Vernon 的 **《实现领域驱动设计》**（又名红皮书）启发，以及 Eric Evans **《领域驱动设计-大型复杂软件的核心应对之道》** (又名绿皮书)的影响。你真的应该买来这两本书并仔细地阅读它们。你应该爱上它们。

## 谁应该阅读此书

如果你是一个 PHP 开发人员，架构师或者技术经理，我们强烈推荐此书。它能帮助你成为一个更好的专业人士。它会给你正在开发的应用一个全新的视野和方法。如果你是一个初级开发人员，为了将来能应对模型化任意领域，那么深入地了解值对象，实体，仓储以及领域事件这些技术就是非常重要的。对于平均水平的开发者，要明白六边形架构，框架和应用的边界就是编写现实世界中更容易维护的代码的关键点。更高级的读者将乐于探索如何使用领域事件整合应用以及深入聚合的设计。

尽管领域驱动设计不是关于技术的，你也仍需要使用 HTTP 请求来访问你的领域。在整本书中，我们推荐使用特定的 PHP 框架和库，例如 `Symfony`, `Silex`,和 `Doctrine` 等。对于有些例子，我们也使用一些特定的技术，例如 `MySQL`，`RabbitMQ`，`Redis` 和 `Elasticsearch`。尽管如此，最重要的还是幕后的概念，这些与技术无关的概念。

此外，本书还包含了大量的细节和例子，例如怎样正确地使用 PHP 设计和实现领域驱动设计的构建块，包含值对象，实体，服务，领域事件，聚合，工厂，仓储以及应用服务。本书也诠释了主要的 PHP 框架和库在 DDD 中扮演什么角色。此书同时也教如何在你的应用中使用六边形架构，无论你用的是开源框架还是你自己实现的框架。最后，本书展示如何使用REST框架和消息机制来整合限界上下文。如果你对其中任何一个主题感兴趣，那么此书就是你要的。

## DDD与PHP社区

在2016年，Carlos 和 Christian 参加了首界官方DDD大会 - *DDD Europe*。他们很高兴看到了一些开源领袖，如 Marco Pivetta (Doctrine) 和 Sebastian Bergmann (PHPUnit) 也出席了会议。

领域驱动设计思潮在此会议两年前就来到了 PHP 社区。然而，这里仍然缺乏相关文档及实例代码。为什么呢？我认为许多人还没有在生产中使用过这种方法，甚至像 Java 这样成熟的社区。也许是他们项目的复杂度低，或者是因为他们不知道怎么去用它。无论原因是怎样，本书是专门为 PHP 社区所写。我们的目标之一就是教会你怎样在不依赖特定框架或技术的情况下解决领域问题，来实现你的应用程序。

## 章节总结

本书每章单独的介绍 DDD 的一个战术构建块，同时也包含了对 DDD 的一些介绍，如何整合不同的限界上下文或者应用的一些方法，以及附录。

### 第一章 领域驱动设计入门

领域驱动设计关注的是什么？它在复杂系统中扮演什么角色？它是否值得学习和研究？当开发人员深入其中时需要关注的主要概念是什么？

### 第二章 架构风格

限界上下文可以用不同的方式和方法来实现。不过，有两种风格非常流行，它们是六边形架构和命令查询职责分离+事件源。在这一章，我们将看到这两种主要的架构风格，理解他们的主要强项是什么，同时探索什么时候使用它们。

### 第三章 值对象

值对象是充血模型的基本组成部分。在此章我们将了解它们的主要属性是什么，是什么让它们如何重要。我们将解决如何用 `Doctrine` 和自定义的 ORM 来持久化它们。我们将演示如何正确地验证和对它们进行单元测试。最后，我们将看看测试不变性的测试案例是什么样子。

### 第四章 实体

实体是 DDD 构建块易变的唯一标识。在此章我们将看到如何创建和验证它们，以及如何将它们正确地映射到自定义 ORM 和 `Doctrine`。我们同时将评估注释是否是实体最好的映射方法以及审视生成一个实体的不同策略。

### 第五章 领域服务

在这一章，你将学到什么是领域服务以及什么时候使用它。我们将复习什么是贫血模型和充血模型。最后，我们将应对在编写领域服务时的基础性问题。

### 第六章 领域事件

领域事件是一种非常棒的控制反转机制。在领域驱动设计中，对不同限界上下文的异步交流，用最终一致性来提高应用性能，以及从基础设计来对应用解耦，领域事件都是非常重要的技术。

### 第七章 模块

在这么多战术构建块里，搞懂将它们放到代码的哪个部分是有点困难的，尤其是当你用像 `Symfony` 这样的框架来处理。在此章我们将回顾PHP的命名空间是怎么实现模块的。同时将探索用不同目录层次结构来组织领域模型代码，应用代码和基础设施代码。

### 第八章 聚合

聚合可能是领域驱动设计中最难的一个战术了。在此章我们将审视什么时候应对它们和探索怎样设计它们的关键部分。我们将提出一个实际情景：当添加一个业务规则时，使得两个聚合变成一个。以及演示如何将剩下的对象重构。

### 第九章 工厂

工厂方法和对象可以帮助我们保持业务的不变性，这也是它们为什么在 DDD 中如此重要的原因。在这一章，我们将探索工厂和聚合之间的关系。

### 第十章 仓储层

仓储层是检索和新增实体和聚合到集合中的关键。在此章中我们将回顾不同类型的仓储，以及学习怎样用 `Doctrine`，自定义 ORM 和 `Redis` 来实现它们。

### 第十一章 应用层

应用层是连接外部客户端到你的领域间非常薄的那一层。在这一章里，我们将展示怎样编写应用服务以便很容易地测试它们并保持轻薄。我们将同时回顾怎样准备请求对象，定义依赖和返回结果。

### 第十二章 整合限界上下文

在本章中我们将探索限界上下文间通信的不同战术方法以及它们的实际实现。REST 是我们推荐的同步通信方法，用 `RabbitMQ` 实现的消息队列 是我们建议的异步通信方法。

### 附录 第十三章 用PHP实现六边形架构

这一章，你将找到 Carlos 于2014年6月在*php[architect]*发表的原文。

### 代码与例子

作者们在 *GitHub* 创建了一个叫 *Domain-Driven Design in PHP* 的组织，本书的所有代码都在这里找到，包括一些附加的代码片段，和一些完整可用的示例项目。例如，你可以找到一个叫 *Last Wishes* 的东西，一个展示了本书中不同例子的 DDD 风格的简单应用。除此之外，你还能在里面找到 *CQRS Blog*，以及 *Gamify*，一个为 *Last Wishes* 增加游戏化能力的限界上下文。

最后，如果在阅读此书时，你发现任何问题和修正或者建议与评注，你可以在 *DDD in PHP Book Issues* 仓库中提交你的问题。只要提出来我们就会修正它们，如果你有兴趣，我们将督促你关注我们的项目并提供反馈。
