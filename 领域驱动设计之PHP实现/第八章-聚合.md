# 聚合

聚合可能是领域驱动设计中最难的构建块了。它们难以理解，并且难以正确设计。但不用担心，我们会帮助你。不过，在进入聚合之前，我们首先需要深入了解一些概念：事务和并发策略。

## 介绍

如果你使用过电子商务应用，则可能已经遇到过与数据库中数据不一致有关的错误。例如，考虑一个总额为 99.99 美元的购物订单，该订单与订单中每行总金额的总和 89.99 美元不匹配。那这笔额外的 10 美元来自哪里？

或者，考虑一个为影院售卖电影票的网站。有一个剧院有 100 个可用座位，并且在电影成功上映之后，每个人都在网站上等待购票。一旦你开售，一切都会快速进行，最终你会以某种方式卖出了 102 张门票。你可能已经指定只有 100 个座位，但是由于某种原因你超过了该阈值。

你可能有使用像 JIRA 或者 Redmine 之类的追踪系统的经验。考虑一个开发，QA，以及一个产品经理的小组。如果每个人都在计划会议中，围绕用户故事分类和移动它们然后保存，这会发生什么问题？最终的待办项或者
冲突优先级可能会是团队中最后保存它的人。

一般来说，当我们用一种非原子方式处理持久化机制时，会发生数据不一致。一个例子就是，当你发送三个查询请求到数据库，它们中的一些正常一些不正常。数据库的最终状态就会不一致。有时，你希望这三个查询请求全部成功或者失败，那么可以用事务。不过要注意，正如你将在这章看到的，并不是所有非一致性问题都用事务解决。事实上，有时一些数据不一致情况需要锁或者并发策略来解决。这些工具可能会影响你的应用性能，所以请注意权衡。

你可能认为这些数据不一致情况仅仅发生在数据库，但实际不是这样。例如，如果我们使用一个面向文档数据库（诸如 Elasticsearch），两个文档间数据可能会不一致。此外，大多数 NoSQL 持久化存储系统都不支持 ACID 事务。这意味着你不能在单个操作上持久化或更新多个文档。因此，如果我们对 Elasticsearch 作出不同请求，则可能会失败，从而使保存在 Elasticsearch 中的数据不一致。

保证数据一致性是一个挑战。不将基础设施问题泄漏到领域中是一个更大的挑战。聚合可以帮助你处理这些问题。

## 关键概念

持久化引擎，特别是数据库，具有一些解决数据不一致的功能：ACID，约束，引用完整性，锁，并发控制和事务。在使用聚合之前，让我们回一下这些概念。

这些概念的大多数在互联网上都是对公开开放的。我们想感谢在 Oracle，PostgreSQL，以及 Doctrine 的人，用他们的文档做出了令人惊叹的工作。他们细致地定义和解释了这些重要内容，并且不是重复造轮子，我们整理了一些官方解释以分享给你。

### ACID (事务管理)

正如在上一节中讨论的，ACID 代表原子性 (atomicity），一致性 (consistency)，隔离性 (isolation)，以及持久性 (durability)。根据 MySQL 词汇表：

> 这些属性都是数据库系统所需要的，并且都与事务概念紧密相关。例如，MySQL InnoDB 引擎的事务功能遵循 ACID 原则。
>  
> 事务是原子工作单元，它可以被提交和回滚。当一个事务都数据库做出多种改变，要么当事务提交时所有改变都成功，要么当事务回滚时所有改变都失败。
>  
> 在每个提交或回滚之后，以及在事务的进程中，数据库总是保持一个一致性状态。如果要跨越多个表更新了相关数据，那么查询将看到所有旧值或所有新值，而不是新旧值的混合。
>  
> 
### 事务 (Transactions)

### 隔离级别 (Isolation Levels)

### 引用完整性 (Referential Integrity)

### 锁 (Locking)

### 并发 (Concurrency)

#### 悲观并发控制 (PCC)

##### 使用 Doctrine

#### 乐观并发控制 (OCC)

##### 使用 Elasticsearch

##### 使用Doctrine

## 使用聚合

### Martin Fowler 怎么说

### 维基百科 怎么说

## 为什么要聚合

## 一点历史

## 聚合剖析

## 聚合设计原则

### 基于业务真正不变条件设计聚合

### 小聚合 Vs. 臃肿聚合

### 通过标识引用其它实体

### 每个事务和请求只更新一个聚合

### 应用服务示例：用户与愿望

#### 非不变性，两个聚合

#### 每个用户不超过三个愿望

##### 悲观并发控制

##### 乐观并发控制

## 事务

## 小结
